---
title: "Lab 8: Modeling Dipper Survival by Sex"
author: "Cat Adams"
date: "`r Sys.Date()`"
output: html_document
---
<style type="text/css">
  body{
  font-size: 12pt;
}
pre{
  font-size: 20px; 
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(tidyverse)
library(stringr)
library(rjags)
library(coda)
library(bayesplot)
library(ggplot2)
library(grateful)
# default ggplot theme i use for all my figures
  theme<-theme(text=element_text(#family="Times New Roman",
  size=14),
        plot.title=element_text(hjust=0.5, size=12, color= "black"),
        axis.line=element_line(color="black"),
        panel.background=element_rect(fill="white"),
        legend.title = element_text(size=12, color="black"),
        legend.text=element_text(size=12,color="black"),
        axis.text.x = element_text(size=16, color="black", vjust=0.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title  = element_text(size=16,color="black"),
        axis.title.x = element_text(
          margin = margin(t = 10, r = 0, b = 0, l = 0)),
        axis.title.y = element_text(
          margin = margin(t = 0, r = 10, b = 0, l = 0)))
```


## Step 1
 Fit a CJS survival model that includes a sex effect on survival probability.
 Do this by adapting the jags model code in the file (cjs1.r) and implementation code that is above.
```{r step1, message = FALSE, warning = FALSE}
#Get data
  dipper = read.table("DIPPER.INP", skip = 2,sep="", colClasses = "character")

# split column 1 into columns
  CH = matrix(as.integer(str_split_fixed(dipper[,1],"",7)),nrow=nrow(dipper))

  #  Sex variable: female = 1; male = 0
  sex = as.integer(dipper$V3)


# Create vector with occasion of marking for each individual (row of CH)
  get.first <- function(x) min(which(x!=0))
  f <- apply(CH, 1, get.first)

# Bundle data
  jags.data <- list(y = CH, 
                    f = f,
                    nind = dim(CH)[1],
                    n.occasions = dim(CH)[2],
                    x=sex)
  
# z initial values matrix
  z.init <- matrix(NA, nrow = nrow(CH), ncol = ncol(CH))
  for(i in 1:dim(z.init)[1]){
    z.init[i, f[i]:dim(z.init)[2]] <- 1
    z.init[i,f[i]] <- NA
  }

# Create inits function  
  # p are random values while z is our z.init. no phi now because it is parameterized
  # by bo and b1 (random values)
  inits <- function(){list(b0=runif(1, 0, 1), b1=runif(1, 0, 1), p = runif(1, 0, 1), z = z.init)}

# Parameters monitored
  parameters <- c("b0","b1", "p")

# MCMC settings
  ni <- 10000 # number of iterations
  nt <- 2     # number of iterations to thin by
  nb <- 5000  # number of iterations to burn (to toss out initially)
  na <- 1000  # number of iterations to use to adapt to sample efficiently
  nc <- 3     # number of chains

# Call JAGS from R 
# Setup the Model
  jm=jags.model(file="model.jags.cjs_dippersex.r",
                data=jags.data,n.chains=nc,n.adapt=na,inits=inits)

# Update the model with the burnin
  update(jm, n.iter=nb)

#Fit the model
  post=coda.samples(jm, variable.names=parameters, n.iter=ni, thin=nt)
```

## Step 2
 Check that parameters have converged. Show evidence of this by plotting and calculating
 the gelman-rubin convergence diagnostic, i.e, function gelman.diag. Make comments about what the plots
 and diagnostic statistic is telling you.

```{r step 2, echo = FALSE}
#Interpret the results  
  # summary(post) 

#Trace plots of the estimates across the three chains and the density plots of the estimates
  plot(post)

#gelman-rubin convergence diagnostic
  coda::gelman.diag(post)

# Highest posterior density intervals  ('credible intervals')
  # coda::HPDinterval(post[[1]], prob = 0.95)
```

The plots and gelman-rubin convergence diagnostic tell me there is concurrence among the 3 chains used to estimate the parameters, which suggests that the model likely has good estimates. We can see this in the plots as the trace plots of the parameters show the chains highly overlapping, and the density plots are relatively symmetrical. Also, The gelman-rubin convergence diagnostic shows the point estimates and upper C.I. values as 1 for each parameter, which similarly suggests three chains in the analysis are in agreement.

## Step 3
 Use the estimated posterior parameters of survival to derive the posterior distributions
 for the probability of survival for males and females. Visualize these distributions on the same plot.
 
 
```{r step3, echo=FALSE}
# creating a vector of transformed b0 parameters from the model. Transformed values represent
# apparent survival probability of males
maleSurvival<-plogis(as.matrix(post)[,1])

# creating a vector of transformed b0 + b1 parameters from the model. Transformed values represent
# apparent survival probability of females
femaleSurvival<-plogis(as.matrix(post)[,1]+ as.matrix(post)[,2])

#mean b0 transformed to a probability. Mean probability of male apparent survival
MeanMaleSurvival<-plogis(mean(as.matrix(post)[,1]))

#mean b0 + mean b1 transformed into a probability. Mean probability of female apparent survival
MeanFemaleSurvival<-plogis(mean(as.matrix(post)[,1])+ mean(as.matrix(post)[,2]))

# creating a data frame with male and female probability values from the posterior distributions 
# for plotting in ggplot (I like ggplot....)
survival_data <- data.frame(
  Survival = c(maleSurvival, femaleSurvival),
  Gender = factor(rep(c("Male", "Female"), c(length(maleSurvival), length(femaleSurvival))))
)

# plotting posterior probabilities of male and female survival along with text of the actual
# estimated mean apparent survival probabilities of males and females.
ggplot(survival_data, aes(x = Survival, color = Gender)) +
  geom_density(lwd=1.5) +
  labs(title = "Plots of Posterior Distributions of Male and Female\nApparent Survival of European Dippers",
       x = "Probability of Apparent Survival",
       y = "Density") +
  scale_color_manual(values = c("Male" = "blue", "Female" = "red")) +
  theme+
  annotate("text", x = Inf, y = Inf, label = paste("Mean Male Survival:", round(MeanMaleSurvival, 3)), 
           hjust = 1, vjust = 1.4, size = 4, color = "blue")+
  annotate("text", x = Inf, y = Inf, label = paste("Mean Female Survival:", round(MeanFemaleSurvival, 3)), 
           hjust = 1, vjust = 3.5, size = 4, color = "red")
```

## Step 4
 Use Monte Carlo integration on the sex effect parameter to estimate the probability that the
 the effect difference of male survival is less than female survival
```{r step 4, include=FALSE}
#probability that male survival is greater than female
diff1=maleSurvival-femaleSurvival
length(which(diff1>0))/length(diff1)

#probability that female survival is greater than male
diff2=femaleSurvival - maleSurvival
length(which(diff2>0))/length(diff2)

#sex effect parameter is b1?
# if so than the sex effect difference would be greater for males if it was
# negative and greater for females if it was positive. so...
# this is length of the posterior distribution of b1 where it is positive
# (thus female would have greater survival than male) divided by the length of
# the posterior distribution of b1
length(which(as.matrix(post)[,2]>0))/length(as.matrix(post)[,2])

# interestingly or uninterestingly, this is the same as the probability that female 
# survival is greater than male

```
 The probability of the effect difference of male survival being less than female survival is 0.349.
 
## **Appendix**

### Software


This report was generated from the R Statistical Software (v4.2.2; R Core Team 2021) using the [Markdown language](https://www.markdownguide.org/) and [RStudio](https://posit.co/products/open-source/rstudio/). The R packages used are acknowledged below. 

```{r packages, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
  pkgs <- cite_packages(output = "table", out.dir = ".")
  knitr::kable(pkgs)
```

